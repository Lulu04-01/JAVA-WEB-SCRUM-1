<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Producto - Veterinaria</title>
    <link rel="stylesheet" href="productoform.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="product-form-container visible">
    <form id="productForm" class="product-form">
        <div class="form-header">
            <h3><i class="fas fa-paw"></i> <span id="formTitle">Agregar Nuevo Producto</span></h3>
            <button type="button" class="close-btn" onclick="window.location.href='inventorymodule.html'">
                &times;
            </button>
        </div>

        <input type="hidden" id="idProducto" name="idProducto">

        <div class="form-grid">
            <!-- Columna Izquierda -->
            <div class="form-column">
                <div class="form-group">
                    <label for="nombre">Nombre del Producto*</label>
                    <input type="text" id="nombre" name="Nombre_Producto" required placeholder="Ej: Antiparasitario Canino">
                </div>

                <div class="form-group">
                    <label for="categoria">Categoría*</label>
                    <select id="categoria" name="Categoria" required>
                        <option value="">Seleccione una categoría</option>
                        <option value="Medicamento">Medicamento</option>
                        <option value="Alimento">Alimento</option>
                        <option value="Accesorio">Accesorio</option>
                        <option value="Insumo">Insumo</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="marca">Marca*</label>
                    <input type="text" id="marca" name="Marca_Producto" required placeholder="Ej: PetCare">
                </div>

                <div class="form-group">
                    <label for="proveedor">Proveedor*</label>
                    <input type="text" id="proveedor" name="Nombre_Proveedor" required placeholder="Ej: Distribuidora Vet">
                </div>
            </div>

            <!-- Columna Derecha -->
            <div class="form-column">
                <div class="form-group">
                    <label for="cantidad">Cantidad*</label>
                    <input type="number" id="cantidad" name="Cantidad_Producto" required min="1" placeholder="Ej: 50">
                </div>

                <div class="form-group">
                    <label for="precio">Precio Unitario*</label>
                    <div class="input-with-symbol">
                        <span>$</span>
                        <input type="number" id="precio" name="Precio_Producto" required step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="stock">Stock Mínimo*</label>
                    <input type="number" id="stock" name="Stock_Producto" required min="1" placeholder="Ej: 10">
                </div>

                <div class="form-group">
                    <label for="caducidad">Fecha de Caducidad*</label>
                    <input type="date" id="caducidad" name="Fecha_Caducidad" required>
                </div>
            </div>
        </div>

        <div class="form-group full-width">
            <label for="descripcion">Descripción*</label>
            <textarea id="descripcion" name="Descripcion_Producto" required placeholder="Descripción detallada del producto..." rows="3"></textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="window.location.href='inventorymodule.html'">
                Cancelar
            </button>
            <button type="submit" class="submit-btn">
                <i class="fas fa-save"></i> <span id="submitText">Guardar Producto</span>
            </button>
        </div>
    </form>
    <div class="overlay" onclick="window.location.href='inventorymodule.html'"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const contextPath = '/' + window.location.pathname.split('/')[1];
        const urlParams = new URLSearchParams(window.location.search);
        const idProducto = urlParams.get('id');

        console.log('ID del producto a editar:', idProducto);

        if (idProducto) {
            document.getElementById('formTitle').textContent = 'Editar Producto';
            document.getElementById('submitText').textContent = 'Actualizar Producto';

            fetch(`${contextPath}/api/productos/editar/${idProducto}`, {
                credentials: 'include'
            })
                .then(response => {
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(text => {
                            throw new Error(`El servidor devolvió HTML cuando se esperaba JSON: ${text.substring(0, 100)}...`);
                        });
                    }

                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || "Error del servidor");
                        });
                    }

                    return response.json();
                })
                .then(producto => {
                    console.log("Producto recibido:", producto);
                    document.getElementById('idProducto').value = producto.idProducto;
                    document.getElementById('nombre').value = producto.Nombre_Producto;
                    document.getElementById('categoria').value = producto.Categoria;
                    document.getElementById('marca').value = producto.Marca_Producto;
                    document.getElementById('proveedor').value = producto.Nombre_Proveedor;
                    document.getElementById('cantidad').value = producto.Cantidad_Producto;
                    document.getElementById('precio').value = producto.Precio_Producto;
                    document.getElementById('stock').value = producto.Stock_Producto;

                    if (producto.Fecha_Caducidad) {
                        const fecha = new Date(producto.Fecha_Caducidad);
                        document.getElementById('caducidad').value = fecha.toISOString().split('T')[0];
                    }
                    document.getElementById('descripcion').value = producto.Descripcion_Producto || '';
                })
                .catch(error => {
                    console.error('Error completo:', error);
                    alert(error.message);
                });
        }

        document.getElementById('productForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const idProducto = formData.get('idProducto');
            const url = idProducto ? `${contextPath}/api/productos/editar/${idProducto}` : `${contextPath}/api/productos`;
            const method = idProducto ? 'PUT' : 'POST';

            const producto = {
                idProducto: parseInt(formData.get("idProducto")),
                Nombre_Producto: formData.get("Nombre_Producto"),
                Categoria: formData.get("Categoria"),
                Marca_Producto: formData.get("Marca_Producto"),
                Cantidad_Producto: parseInt(formData.get("Cantidad_Producto")),
                Precio_Producto: parseFloat(formData.get("Precio_Producto")),
                Nombre_Proveedor: formData.get("Nombre_Proveedor"),
                Fecha_Caducidad: formData.get("Fecha_Caducidad"),
                Descripcion_Producto: formData.get("Descripcion_Producto"),
                Stock_Producto: parseInt(formData.get("Stock_Producto"))
            };

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(producto)
            })
                .then(response => {
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(text => {
                            throw new Error(`Respuesta inesperada: ${text.substring(0, 100)}...`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(idProducto ? 'Producto actualizado correctamente' : 'Producto creado correctamente');
                    window.location.href = 'inventorymodule.html';
                })
                .catch(error => {
                    console.error('Error al guardar el producto:', error);
                    alert('Error al guardar: ' + error.message);
                });
        });
    });
</script>

</body>
</html>
